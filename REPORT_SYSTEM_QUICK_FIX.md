# 举报系统快速修复指南

## 问题诊断

用户遇到 "Failed to submit report" 错误，可能的原因：

1. **数据库表未创建**：`work_reports` 表可能还不存在
2. **数据库函数缺失**：自定义函数可能未正确创建
3. **权限问题**：API可能没有数据库写入权限

## 已实施的修复

### 1. 简化API实现 ✅
- 移除对数据库函数的依赖
- 直接使用 `INSERT` 语句
- 添加表不存在时的降级处理

### 2. 增强错误处理 ✅
- 添加详细的错误日志
- 提供开发模式的模拟响应
- 改进前端错误显示

### 3. 测试API端点 ✅
- 创建 `/api/reports/test` 用于测试
- 开发模式自动使用测试端点
- 不依赖任何数据库操作

## 测试步骤

### 1. 测试API连通性
```bash
curl http://localhost:3000/api/reports/test
```

应该返回：
```json
{
  "status": "ok",
  "message": "Report test API is working",
  "timestamp": "2024-..."
}
```

### 2. 测试举报提交
在开发模式下，举报系统会自动使用测试API，应该能正常工作。

### 3. 检查浏览器控制台
查看详细的错误日志和API调用信息。

## 数据库设置（可选）

如果要启用完整功能，需要运行数据库迁移：

```sql
-- 运行 src/backend/supabase/migrations/add_report_system.sql
-- 这将创建所有必要的表和函数
```

## 临时解决方案

### 开发环境
- 系统自动使用测试API
- 所有功能正常工作（模拟数据）
- 不需要数据库设置

### 生产环境
- 需要运行数据库迁移
- 配置正确的环境变量
- 确保API权限正确

## 文件修改摘要

### API修复
- `app/api/reports/submit/route.ts` - 简化数据库操作
- `app/api/ai/copyright-arbitration/route.ts` - 移除函数依赖
- `app/api/ai/content-moderation/route.ts` - 直接表操作

### 前端修复
- `components/whichwitch/report-modal.tsx` - 改进错误处理

### 测试工具
- `app/api/reports/test/route.ts` - 测试API端点

## 验证清单

- [ ] 测试API响应正常
- [ ] 举报模态框能打开
- [ ] 表单验证工作正常
- [ ] 提交按钮响应
- [ ] 错误信息清晰显示
- [ ] 成功状态正确显示

## 下一步

1. **立即可用**：当前修复应该解决提交失败问题
2. **完整功能**：运行数据库迁移启用所有功能
3. **生产部署**：配置环境变量和权限

## 故障排除

### 如果仍然失败
1. 检查网络连接
2. 查看浏览器开发者工具
3. 检查服务器日志
4. 尝试刷新页面

### 常见错误
- **404错误**：API路由未正确设置
- **500错误**：服务器内部错误，查看日志
- **权限错误**：数据库访问权限问题

## 联系支持

如果问题持续存在，请提供：
1. 浏览器控制台错误信息
2. 网络请求详情
3. 服务器日志（如果可访问）