# 🔍 功能缺失分析和解决方案

## 📋 当前问题清单

### ❌ 1. 数据库未连接
**问题**: Supabase 客户端已配置，但没有实际的数据库操作代码
**影响**: 无法保存用户信息、作品数据、收藏记录

### ❌ 2. 合约未集成
**问题**: 合约地址和 ABI 已配置，但缺少实际调用合约的代码
**影响**: 无法进行链上操作（创建作品、支付、授权）

### ❌ 3. 钱包连接不完整
**问题**: 钱包连接代码已添加，但未完全集成到登录流程
**影响**: 用户无法真正连接钱包并使用 DApp

### ❌ 4. 前端只有 Mock Data
**问题**: 所有数据都是硬编码的假数据
**影响**: 无法显示真实的用户互动信息

### ❌ 5. 登录流程不符合需求
**问题**: 当前有两个按钮，需求只要一个 "Connect Wallet"
**影响**: 用户体验不符合设计

### ❌ 6. 缺少用户 ID 生成逻辑
**问题**: 没有平台生成用户 ID 的代码
**影响**: 无法区分新老用户

### ❌ 7. 广场数据未从数据库获取
**问题**: 广场显示的是 mock data，不是链上作品
**影响**: 无法显示真实作品

### ❌ 8. Tip 功能未实现
**问题**: 没有触发合约的 tip 功能
**影响**: 用户无法打赏作品

### ❌ 9. 收藏功能只在前端
**问题**: 收藏只更新本地状态，不保存到数据库
**影响**: 刷新页面后收藏丢失

### ⚠️ 10. 收藏夹状态管理部分完成
**已完成**: 前端 UI 已实现五种状态的显示（徽章和按钮）
**缺少**: 后端逻辑 - 从数据库查询状态、根据合约更新状态
**影响**: 状态都是 mock data，无法反映真实的授权状态

### ❌ 11. 作品上传未连接合约和数据库
**问题**: 上传只是前端模拟，没有真正上链
**影响**: 作品无法永久保存

### ❌ 12. 个人资料未显示真实数据
**问题**: 余额、withdraw 等功能未实现
**影响**: 用户无法查看和提取收益

### ❌ 13. 创作谱系树未实现
**问题**: 没有从合约获取祖先链并渲染树状图
**影响**: 无法显示作品的创作关系

---

## 🎯 解决方案架构

### 第一阶段：基础设施（必须先完成）

#### 1.1 数据库服务层
创建 `src/ui/lib/supabase/services.ts`
- 用户 CRUD 操作
- 作品 CRUD 操作
- 收藏 CRUD 操作
- 授权请求 CRUD 操作

#### 1.2 合约服务层
创建 `src/ui/lib/web3/services.ts`
- 创建作品
- 请求授权
- 支付和分配收益
- 查询作品信息
- 获取祖先链

#### 1.3 IPFS 服务层
创建 `src/ui/lib/ipfs/pinata.ts`
- 上传图片到 IPFS
- 上传 metadata 到 IPFS
- 获取 IPFS URL

### 第二阶段：核心功能实现

#### 2.1 登录流程重构
**文件**: `src/ui/components/whichwitch/auth-view.tsx`

```typescript
// 新用户流程
1. 点击 "Connect Wallet"
2. 连接 MetaMask
3. 检查数据库是否存在该钱包地址
4. 如果不存在 → 显示注册表单
5. 填写平台账号信息
6. 保存到数据库（生成用户 ID）
7. 进入 app 主页

// 老用户流程
1. 点击 "Connect Wallet"
2. 连接 MetaMask
3. 检查数据库存在该钱包地址
4. 直接进入 app 主页
```

#### 2.2 广场功能
**文件**: `src/ui/components/whichwitch/square-view.tsx`

```typescript
// 数据流
1. 从数据库查询所有作品
2. 显示作品卡片
3. 点击 Tip → 调用合约支付
4. 点击收藏 → 保存到数据库
```

#### 2.3 收藏夹功能
**文件**: `src/ui/components/whichwitch/collections-view.tsx`

```typescript
// 五种状态逻辑
1. no remix: 作品的 derivativeAllowed = false
2. empty: 用户未申请授权
3. under review: 授权请求状态 = pending
4. failed: 授权请求状态 = failed
5. approved&paid: 授权请求状态 = approved

// 按钮动作
- no remix → 禁用按钮
- empty → remix 按钮 → 支付界面
- under review → reviewing（灰色）
- failed → try again → 支付界面
- approved&paid → upload work → 跳转上传页面
```

#### 2.4 作品上传功能
**文件**: `src/ui/components/whichwitch/upload-view.tsx`

```typescript
// 上传流程
1. 用户填写作品信息
2. 上传图片到 Pinata IPFS
3. 生成 metadata JSON
4. 上传 metadata 到 Pinata IPFS
5. 获取 metadata URI
6. 调用合约 registerWork/registerDerivativeWork
7. 合约 emit 事件（workId, timestamp）
8. 保存到数据库
9. 更新广场显示
```

#### 2.5 个人资料功能
**文件**: `src/ui/components/whichwitch/profile-view.tsx`

```typescript
// 显示内容
1. 从合约查询用户余额
2. 显示用户 ID（从数据库）
3. Withdraw 按钮调用合约提现
4. 显示用户创作的作品
```

#### 2.6 创作谱系树
**文件**: `src/ui/components/work-genealogy-tree.tsx`

```typescript
// 树状图逻辑
1. 调用合约 getAncestorChain(workId)
2. 获取祖先地址数组
3. 从数据库查询每个地址的作品信息
4. 渲染树状图：
   - 第一层：原创作品（数组第一个）
   - 第二层：当前作品
   - 第三层：直接衍生作品
   - 第四层：二级衍生作品
```

---

## 📁 需要创建的文件

### 服务层（7个文件）
1. `src/ui/lib/supabase/services/user.service.ts` - 用户服务
2. `src/ui/lib/supabase/services/work.service.ts` - 作品服务
3. `src/ui/lib/supabase/services/collection.service.ts` - 收藏服务
4. `src/ui/lib/supabase/services/authorization.service.ts` - 授权服务
5. `src/ui/lib/web3/services/contract.service.ts` - 合约服务
6. `src/ui/lib/ipfs/pinata.service.ts` - IPFS 服务
7. `src/ui/lib/supabase/services/index.ts` - 统一导出

### 组件层（3个文件）
1. `src/ui/components/work-genealogy-tree.tsx` - 创作谱系树
2. `src/ui/components/payment-dialog.tsx` - 支付对话框
3. `src/ui/components/work-status-badge.tsx` - 作品状态徽章

### Hooks（5个文件）
1. `src/ui/lib/hooks/useUser.ts` - 用户数据 hook
2. `src/ui/lib/hooks/useWorks.ts` - 作品数据 hook
3. `src/ui/lib/hooks/useCollections.ts` - 收藏数据 hook
4. `src/ui/lib/hooks/useContract.ts` - 合约操作 hook
5. `src/ui/lib/hooks/useIPFS.ts` - IPFS 上传 hook

---

## 🔧 需要修改的文件

### 1. `src/ui/components/whichwitch/auth-view.tsx`
- ✅ 已添加钱包连接
- ❌ 需要添加数据库检查
- ❌ 需要区分新老用户
- ❌ 需要生成用户 ID

### 2. `src/ui/components/whichwitch/square-view.tsx`
- ❌ 需要从数据库获取作品
- ❌ 需要实现 Tip 功能
- ❌ 需要实现收藏功能

### 3. `src/ui/components/whichwitch/collections-view.tsx`
- ❌ 需要从数据库获取收藏
- ❌ 需要实现五种状态逻辑
- ❌ 需要实现授权申请流程

### 4. `src/ui/components/whichwitch/upload-view.tsx`
- ❌ 需要连接 IPFS
- ❌ 需要调用合约
- ❌ 需要保存到数据库
- ❌ 需要修复 allowance 开关显示

### 5. `src/ui/components/whichwitch/profile-view.tsx`
- ❌ 需要显示真实余额
- ❌ 需要实现 withdraw 功能
- ❌ 需要显示用户 ID

### 6. `src/ui/components/whichwitch/work-card.tsx`
- ❌ 需要添加创作谱系树
- ❌ 需要显示 total remix 数
- ❌ 需要显示 remixed by 信息

---

## 📊 数据流图

```
用户操作
    ↓
前端组件
    ↓
    ├─→ Supabase Service → Supabase 数据库
    │                          ↓
    │                      保存/查询数据
    │
    ├─→ Contract Service → 智能合约（Sepolia）
    │                          ↓
    │                      链上操作 + emit 事件
    │
    └─→ IPFS Service → Pinata
                          ↓
                      上传文件/metadata
```

---

## 🚀 实施优先级

### P0 - 必须立即完成（核心功能）
1. ✅ 钱包连接（已完成）
2. ⏳ 数据库服务层
3. ⏳ 合约服务层
4. ⏳ 登录流程重构
5. ⏳ 广场数据从数据库获取

### P1 - 高优先级（主要功能）
6. ⏳ 收藏功能连接数据库
7. ⏳ 作品上传连接 IPFS + 合约
8. ⏳ 五种作品状态逻辑
9. ⏳ 授权申请和支付流程

### P2 - 中优先级（增强功能）
10. ⏳ 个人资料显示真实数据
11. ⏳ Withdraw 功能
12. ⏳ Tip 功能
13. ⏳ 创作谱系树

### P3 - 低优先级（UI 优化）
14. ⏳ Allowance 开关显示优化
15. ⏳ Total remix 统计
16. ⏳ Remixed by 显示

---

## 💡 下一步行动

### 立即开始
1. 创建数据库服务层文件
2. 创建合约服务层文件
3. 创建 IPFS 服务层文件
4. 重构登录流程
5. 更新广场组件使用真实数据

### 预计工作量
- 服务层：2-3 小时
- 登录流程：1 小时
- 广场功能：1 小时
- 收藏功能：1-2 小时
- 上传功能：2-3 小时
- 个人资料：1 小时
- 创作谱系树：2 小时

**总计：10-15 小时开发时间**

---

## ⚠️ 注意事项

1. **数据库 Schema 必须先运行**
   - 在 Supabase Dashboard 执行 `src/backend/supabase/schema.sql`

2. **合约必须已部署**
   - 确认 `.env.local` 中的合约地址正确

3. **测试网测试币**
   - 确保有足够的 Sepolia ETH 进行测试

4. **IPFS 配置**
   - 确认 Pinata API 密钥有效

5. **错误处理**
   - 所有服务层都需要完善的错误处理
   - 用户友好的错误提示

---

**准备好开始实施了吗？我可以按优先级逐步创建这些文件。**
