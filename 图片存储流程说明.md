# ğŸ“¸ å›¾ç‰‡å­˜å‚¨æµç¨‹è¯¦è§£

## æ¶æ„è®¾è®¡

### å­˜å‚¨ä½ç½®
- **å›¾ç‰‡æ–‡ä»¶** â†’ IPFS (Pinata)
- **å›¾ç‰‡ URL** â†’ Supabase æ•°æ®åº“
- **Metadata** â†’ IPFS (Pinata)

### æ•°æ®åº“ Schema
```sql
CREATE TABLE works (
  id SERIAL PRIMARY KEY,
  work_id INTEGER NOT NULL,
  creator_address TEXT NOT NULL,
  title TEXT NOT NULL,
  image_url TEXT NOT NULL,        -- IPFS URL: https://gateway.pinata.cloud/ipfs/QmXxx...
  metadata_uri TEXT NOT NULL,     -- IPFS URI: ipfs://QmYyy...
  -- å…¶ä»–å­—æ®µ...
);
```

---

## ğŸ“¤ å®Œæ•´ä¸Šä¼ æµç¨‹

### æ­¥éª¤ 1: ç”¨æˆ·é€‰æ‹©å›¾ç‰‡
```typescript
// åœ¨ upload-view.tsx ä¸­
<input 
  type="file" 
  accept="image/*"
  onChange={handleImageSelect}
/>

const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    setSelectedImage(file);
    // æ˜¾ç¤ºé¢„è§ˆ
    const preview = URL.createObjectURL(file);
    setImagePreview(preview);
  }
};
```

### æ­¥éª¤ 2: ä¸Šä¼ å›¾ç‰‡åˆ° IPFS
```typescript
import { uploadFileToPinata } from '@/lib/ipfs/pinata.service';

const handleUpload = async () => {
  try {
    // 1. ä¸Šä¼ å›¾ç‰‡åˆ° Pinata
    const imageHash = await uploadFileToPinata(selectedImage);
    console.log('Image uploaded to IPFS:', imageHash);
    // ä¾‹å¦‚: QmXoypizjW3WknFiJnKLwHCnL72vedxjQkDDP1mXWo6uco
    
    // 2. ç”Ÿæˆ IPFS URL
    const imageUrl = `https://gateway.pinata.cloud/ipfs/${imageHash}`;
    
    // 3. åˆ›å»º metadata
    const metadata = {
      name: workTitle,
      description: workDescription,
      image: `ipfs://${imageHash}`,  // æ ‡å‡† NFT metadata æ ¼å¼
      attributes: [
        { trait_type: 'Material', value: 'Digital' },
        { trait_type: 'Style', value: 'Abstract' },
      ],
    };
    
    // 4. ä¸Šä¼  metadata åˆ° IPFS
    const metadataHash = await uploadJSONToPinata(metadata);
    const metadataUri = `ipfs://${metadataHash}`;
    
    // 5. è°ƒç”¨åˆçº¦æ³¨å†Œä½œå“
    const { hash, workId } = await registerOriginalWork(
      licenseFee,
      allowRemix,
      metadataUri
    );
    
    // 6. ä¿å­˜åˆ°æ•°æ®åº“
    await createWork({
      workId: Number(workId),
      creatorAddress: address,
      title: workTitle,
      description: workDescription,
      imageUrl: imageUrl,  // å­˜å‚¨ IPFS URL
      metadataUri: metadataUri,
      allowRemix: allowRemix,
      // ...
    });
    
    console.log('Work created successfully!');
  } catch (error) {
    console.error('Upload failed:', error);
  }
};
```

### æ­¥éª¤ 3: ä»æ•°æ®åº“è¯»å–å¹¶æ˜¾ç¤º
```typescript
// åœ¨ square-view.tsx ä¸­
const { works } = useWorks();

// works æ•°æ®ç»“æ„
{
  work_id: 1,
  title: "My Artwork",
  image_url: "https://gateway.pinata.cloud/ipfs/QmXxx...",
  metadata_uri: "ipfs://QmYyy...",
  // ...
}

// æ˜¾ç¤ºå›¾ç‰‡
<img src={work.image_url} alt={work.title} />
```

---

## ğŸ”„ ä¸¤ç§å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ A: IPFS + Supabaseï¼ˆå½“å‰ä½¿ç”¨ï¼‰âœ…

**ä¼˜ç‚¹ï¼š**
- âœ… å»ä¸­å¿ƒåŒ–ï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜
- âœ… ç¬¦åˆ Web3 å’Œ NFT æ ‡å‡†
- âœ… æˆæœ¬ä½ï¼ˆSupabase åªå­˜ URLï¼‰
- âœ… å¯ä»¥ä½¿ç”¨ IPFS ç½‘å…³ CDN

**ç¼ºç‚¹ï¼š**
- âš ï¸ éœ€è¦é…ç½® Pinata API
- âš ï¸ é¦–æ¬¡åŠ è½½å¯èƒ½ç¨æ…¢ï¼ˆå¯ç”¨ CDN ä¼˜åŒ–ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- NFT é¡¹ç›®
- Web3 åº”ç”¨
- éœ€è¦æ°¸ä¹…ä¿å­˜çš„å†…å®¹

---

### æ–¹æ¡ˆ B: Supabase Storageï¼ˆå¤‡é€‰ï¼‰

Supabase ä¹Ÿæä¾›å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥å­˜å‚¨å›¾ç‰‡ã€‚

**ä¼˜ç‚¹ï¼š**
- âœ… é…ç½®ç®€å•
- âœ… åŠ è½½é€Ÿåº¦å¿«
- âœ… ä¸æ•°æ®åº“é›†æˆå¥½

**ç¼ºç‚¹ï¼š**
- âŒ ä¸­å¿ƒåŒ–å­˜å‚¨
- âŒ ä¸ç¬¦åˆ Web3 ç†å¿µ
- âŒ å­˜å‚¨æˆæœ¬è¾ƒé«˜

**å®ç°ä»£ç ï¼š**
```typescript
import { supabase } from '@/lib/supabase/client';

// ä¸Šä¼ åˆ° Supabase Storage
const uploadToSupabase = async (file: File) => {
  const fileName = `${Date.now()}-${file.name}`;
  
  const { data, error } = await supabase.storage
    .from('works')  // bucket åç§°
    .upload(fileName, file);
  
  if (error) throw error;
  
  // è·å–å…¬å¼€ URL
  const { data: { publicUrl } } = supabase.storage
    .from('works')
    .getPublicUrl(fileName);
  
  return publicUrl;
};
```

---

## ğŸ“Š æ•°æ®åº“ä¸­çš„å›¾ç‰‡å­—æ®µ

### works è¡¨
```sql
CREATE TABLE works (
  id SERIAL PRIMARY KEY,
  work_id INTEGER NOT NULL,
  
  -- å›¾ç‰‡ç›¸å…³å­—æ®µ
  image_url TEXT NOT NULL,        -- IPFS URL æˆ– Supabase Storage URL
  metadata_uri TEXT NOT NULL,     -- IPFS metadata URI
  
  -- å…¶ä»–å­—æ®µ
  title TEXT NOT NULL,
  description TEXT,
  creator_address TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### ç¤ºä¾‹æ•°æ®
```json
{
  "work_id": 1,
  "title": "Cyberpunk City",
  "image_url": "https://gateway.pinata.cloud/ipfs/QmXoypizjW3WknFiJnKLwHCnL72vedxjQkDDP1mXWo6uco",
  "metadata_uri": "ipfs://QmYyy...",
  "creator_address": "0x1234...5678"
}
```

---

## ğŸ¨ å‰ç«¯æ˜¾ç¤ºå›¾ç‰‡

### æ–¹æ³• 1: ç›´æ¥ä½¿ç”¨ IPFS URL
```tsx
<img 
  src={work.image_url} 
  alt={work.title}
  className="w-full h-full object-cover"
/>
```

### æ–¹æ³• 2: ä½¿ç”¨ Next.js Image ç»„ä»¶
```tsx
import Image from 'next/image';

<Image
  src={work.image_url}
  alt={work.title}
  width={400}
  height={400}
  className="object-cover"
/>
```

### æ–¹æ³• 3: å¤„ç† IPFS URI
```typescript
import { ipfsToHttp } from '@/lib/ipfs/pinata.service';

// å¦‚æœ metadata ä¸­çš„ image æ˜¯ ipfs:// æ ¼å¼
const imageUrl = ipfsToHttp(metadata.image);
// ipfs://QmXxx... â†’ https://gateway.pinata.cloud/ipfs/QmXxx...

<img src={imageUrl} alt={work.title} />
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ–‡ä»¶å¤§å°é™åˆ¶
```typescript
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

const validateFile = (file: File) => {
  if (file.size > MAX_FILE_SIZE) {
    throw new Error('File too large. Max size is 10MB');
  }
  
  if (!file.type.startsWith('image/')) {
    throw new Error('Only image files are allowed');
  }
};
```

### 2. æ–‡ä»¶ç±»å‹æ£€æŸ¥
```typescript
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

if (!ALLOWED_TYPES.includes(file.type)) {
  throw new Error('Invalid file type');
}
```

### 3. å›¾ç‰‡å‹ç¼©ï¼ˆå¯é€‰ï¼‰
```typescript
import imageCompression from 'browser-image-compression';

const compressImage = async (file: File) => {
  const options = {
    maxSizeMB: 1,
    maxWidthOrHeight: 1920,
    useWebWorker: true,
  };
  
  const compressedFile = await imageCompression(file, options);
  return compressedFile;
};
```

---

## ğŸš€ å®Œæ•´ç¤ºä¾‹ï¼šä½œå“ä¸Šä¼ ç»„ä»¶

```typescript
'use client';

import { useState } from 'react';
import { useAccount } from 'wagmi';
import { uploadFileToPinata, createAndUploadMetadata } from '@/lib/ipfs/pinata.service';
import { registerOriginalWork } from '@/lib/web3/services/contract.service';
import { createWork } from '@/lib/supabase/services';

export function UploadWorkForm() {
  const { address } = useAccount();
  const [selectedImage, setSelectedImage] = useState<File | null>(null);
  const [imagePreview, setImagePreview] = useState<string>('');
  const [uploading, setUploading] = useState(false);
  
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    licenseFee: '0.01',
    allowRemix: true,
  });

  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      // éªŒè¯æ–‡ä»¶
      if (file.size > 10 * 1024 * 1024) {
        alert('File too large. Max 10MB');
        return;
      }
      
      setSelectedImage(file);
      setImagePreview(URL.createObjectURL(file));
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedImage || !address) return;

    setUploading(true);

    try {
      // 1. ä¸Šä¼ å›¾ç‰‡åˆ° IPFS
      console.log('Uploading image to IPFS...');
      const imageHash = await uploadFileToPinata(selectedImage);
      const imageUrl = `https://gateway.pinata.cloud/ipfs/${imageHash}`;
      
      // 2. åˆ›å»ºå¹¶ä¸Šä¼  metadata
      console.log('Creating metadata...');
      const metadataHash = await createAndUploadMetadata({
        title: formData.title,
        description: formData.description,
        imageHash: imageHash,
        creator: address,
      });
      const metadataUri = `ipfs://${metadataHash}`;
      
      // 3. è°ƒç”¨åˆçº¦æ³¨å†Œä½œå“
      console.log('Registering work on blockchain...');
      const { hash, workId } = await registerOriginalWork(
        formData.licenseFee,
        formData.allowRemix,
        metadataUri
      );
      
      // 4. ä¿å­˜åˆ°æ•°æ®åº“
      console.log('Saving to database...');
      await createWork({
        workId: Number(workId),
        creatorAddress: address,
        title: formData.title,
        description: formData.description,
        imageUrl: imageUrl,
        metadataUri: metadataUri,
        allowRemix: formData.allowRemix,
        licenseFee: formData.licenseFee,
        isRemix: false,
      });
      
      alert('Work uploaded successfully!');
      
      // é‡ç½®è¡¨å•
      setSelectedImage(null);
      setImagePreview('');
      setFormData({ title: '', description: '', licenseFee: '0.01', allowRemix: true });
      
    } catch (error) {
      console.error('Upload failed:', error);
      alert('Upload failed. Please try again.');
    } finally {
      setUploading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* å›¾ç‰‡ä¸Šä¼  */}
      <div>
        <label className="block text-sm font-medium mb-2">Upload Image</label>
        <input
          type="file"
          accept="image/*"
          onChange={handleImageSelect}
          className="block w-full"
        />
        {imagePreview && (
          <img src={imagePreview} alt="Preview" className="mt-4 max-w-xs rounded" />
        )}
      </div>

      {/* æ ‡é¢˜ */}
      <div>
        <label className="block text-sm font-medium mb-2">Title</label>
        <input
          type="text"
          value={formData.title}
          onChange={(e) => setFormData({ ...formData, title: e.target.value })}
          required
          className="w-full px-3 py-2 border rounded"
        />
      </div>

      {/* æè¿° */}
      <div>
        <label className="block text-sm font-medium mb-2">Description</label>
        <textarea
          value={formData.description}
          onChange={(e) => setFormData({ ...formData, description: e.target.value })}
          className="w-full px-3 py-2 border rounded"
          rows={4}
        />
      </div>

      {/* æäº¤æŒ‰é’® */}
      <button
        type="submit"
        disabled={!selectedImage || uploading}
        className="w-full py-3 bg-primary text-white rounded disabled:opacity-50"
      >
        {uploading ? 'Uploading...' : 'Upload Work'}
      </button>
    </form>
  );
}
```

---

## ğŸ“ æ€»ç»“

### å›¾ç‰‡å­˜å‚¨ä½ç½®
- **å›¾ç‰‡æ–‡ä»¶** â†’ IPFS (Pinata)
- **å›¾ç‰‡ URL** â†’ Supabase æ•°æ®åº“çš„ `image_url` å­—æ®µ
- **Metadata** â†’ IPFS (Pinata)

### å®Œæ•´æµç¨‹
1. ç”¨æˆ·é€‰æ‹©å›¾ç‰‡
2. ä¸Šä¼ åˆ° Pinata IPFS â†’ è·å– Hash
3. åˆ›å»º metadata â†’ ä¸Šä¼ åˆ° IPFS
4. è°ƒç”¨åˆçº¦æ³¨å†Œä½œå“
5. ä¿å­˜ URL åˆ° Supabase
6. å‰ç«¯ä» IPFS åŠ è½½æ˜¾ç¤º

### ä¸ºä»€ä¹ˆä¸ç›´æ¥å­˜åœ¨æ•°æ®åº“ï¼Ÿ
- å›¾ç‰‡æ–‡ä»¶å¤ªå¤§ï¼Œæ•°æ®åº“ä¸é€‚åˆå­˜å‚¨
- IPFS æä¾›å»ä¸­å¿ƒåŒ–ã€æ°¸ä¹…å­˜å‚¨
- ç¬¦åˆ Web3 å’Œ NFT æ ‡å‡†
- æˆæœ¬æ›´ä½ï¼Œæ€§èƒ½æ›´å¥½

---

**ğŸ¨ ä½ çš„å›¾ç‰‡æ˜¯å­˜åœ¨ IPFS ä¸Šçš„ï¼ŒSupabase åªå­˜ URLï¼**
