# 🚀 下一步开发计划

## ✅ 刚刚完成

### 1. 收藏功能集成 ✅
- 更新 `collections-view.tsx` 使用 `useCollections` Hook
- 从数据库加载真实收藏数据
- 显示授权状态（5种状态）
- 实现取消收藏功能
- 实现创建文件夹功能
- 添加加载状态

---

## 📊 当前完成度

### ✅ 100% 完成
1. **基础架构**
   - 项目结构
   - 环境变量
   - 数据库初始化

2. **服务层**
   - 数据库服务（用户、作品、收藏、授权）
   - 合约服务（创建、授权、支付）
   - IPFS 服务（Pinata）
   - 自定义 Hooks

3. **核心功能**
   - 钱包连接 ✅
   - 用户登录/注册 ✅
   - 广场显示 ✅
   - 收藏功能 ✅

### ⏳ 80% 完成
4. **授权申请** - UI 完成，需要连接合约支付

### ⏳ 50% 完成
5. **个人资料** - UI 完成，需要显示真实数据

### ❌ 0% 完成
6. **作品上传** - 最重要！需要完整实现
7. **Tip 功能** - 需要连接合约
8. **Withdraw 功能** - 需要连接合约
9. **创作谱系树** - 需要实现可视化

---

## 🎯 优先级排序

### P0 - 核心功能（必须完成）

#### 1. 作品上传功能 🔥
**重要性**: ⭐⭐⭐⭐⭐
**文件**: `src/ui/components/whichwitch/upload-view.tsx`

**需要实现**:
```typescript
1. 图片上传到 Pinata IPFS
2. 创建 metadata 并上传
3. 调用合约注册作品
4. 保存到数据库
5. 刷新广场显示
```

**预计时间**: 2-3 小时

---

#### 2. 授权申请支付流程 🔥
**重要性**: ⭐⭐⭐⭐⭐
**文件**: `src/ui/components/whichwitch/collections-view.tsx`

**需要实现**:
```typescript
1. 点击 "Pay & Mint License"
2. 创建授权请求（数据库 pending）
3. 调用合约支付
4. 监听交易结果
5. 更新状态（approved/rejected）
```

**预计时间**: 1-2 小时

---

### P1 - 重要功能

#### 3. 个人资料真实数据
**重要性**: ⭐⭐⭐⭐
**文件**: `src/ui/components/whichwitch/profile-view.tsx`

**需要实现**:
```typescript
1. 显示用户创作的作品
2. 显示真实余额（从合约）
3. Withdraw 功能
4. 显示平台 ID
```

**预计时间**: 1 小时

---

#### 4. Tip 功能
**重要性**: ⭐⭐⭐
**文件**: `src/ui/components/whichwitch/work-card.tsx`

**需要实现**:
```typescript
1. 点击 Tip 按钮
2. 输入金额
3. 调用合约 processPayment
4. 显示成功/失败
```

**预计时间**: 1 小时

---

### P2 - 增强功能

#### 5. 创作谱系树
**重要性**: ⭐⭐⭐
**文件**: 新建 `src/ui/components/work-genealogy-tree.tsx`

**需要实现**:
```typescript
1. 调用合约 getAncestorChain
2. 获取祖先地址数组
3. 从数据库查询作品信息
4. 渲染树状图
```

**预计时间**: 2-3 小时

---

## 📝 详细实现步骤

### 步骤 1: 作品上传功能（最优先）

#### 1.1 更新 upload-view.tsx
```typescript
import { useState } from 'react';
import { useAccount } from 'wagmi';
import { uploadFileToPinata, createAndUploadMetadata } from '@/lib/ipfs/pinata.service';
import { registerOriginalWork, registerDerivativeWork } from '@/lib/web3/services/contract.service';
import { createWork } from '@/lib/supabase/services';

export function UploadView({ onWorkAdded }: { onWorkAdded: (work: any) => void }) {
  const { address } = useAccount();
  const [uploading, setUploading] = useState(false);
  const [selectedImage, setSelectedImage] = useState<File | null>(null);
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedImage || !address) return;

    setUploading(true);
    try {
      // 1. 上传图片到 IPFS
      const imageHash = await uploadFileToPinata(selectedImage);
      const imageUrl = `https://gateway.pinata.cloud/ipfs/${imageHash}`;
      
      // 2. 创建并上传 metadata
      const metadataHash = await createAndUploadMetadata({
        title: formData.title,
        description: formData.description,
        imageHash: imageHash,
        creator: address,
      });
      const metadataUri = `ipfs://${metadataHash}`;
      
      // 3. 调用合约注册作品
      const { hash, workId } = await registerOriginalWork(
        formData.licenseFee,
        formData.allowRemix,
        metadataUri
      );
      
      // 4. 保存到数据库
      await createWork({
        workId: Number(workId),
        creatorAddress: address,
        title: formData.title,
        description: formData.description,
        imageUrl: imageUrl,
        metadataUri: metadataUri,
        allowRemix: formData.allowRemix,
        licenseFee: formData.licenseFee,
        isRemix: false,
      });
      
      alert('Work uploaded successfully!');
      onWorkAdded({ workId });
      
    } catch (error) {
      console.error('Upload failed:', error);
      alert('Upload failed. Please try again.');
    } finally {
      setUploading(false);
    }
  };
  
  // ... 渲染表单
}
```

---

### 步骤 2: 授权申请支付

#### 2.1 更新 collections-view.tsx 的支付逻辑
```typescript
import { createAuthorizationRequest, updateAuthorizationStatus } from '@/lib/supabase/services';
import { requestAuthorization } from '@/lib/web3/services/contract.service';

const handlePayAndMint = async () => {
  if (!selectedWork || !address) return;
  
  try {
    // 1. 创建授权请求（pending）
    await createAuthorizationRequest(address, selectedWork.id);
    
    // 2. 调用合约支付
    const txHash = await requestAuthorization(
      BigInt(selectedWork.id),
      selectedWork.licenseFee || '0.05'
    );
    
    // 3. 更新状态为 approved
    await updateAuthorizationStatus(
      address,
      selectedWork.id,
      'approved',
      txHash
    );
    
    alert('Authorization granted!');
    setRemixModalOpen(false);
    
  } catch (error) {
    console.error('Authorization failed:', error);
    
    // 更新状态为 failed
    await updateAuthorizationStatus(
      address,
      selectedWork.id,
      'failed',
      undefined,
      error.message
    );
    
    alert('Authorization failed. Please try again.');
  }
};
```

---

### 步骤 3: 个人资料真实数据

#### 3.1 更新 profile-view.tsx
```typescript
import { useWorks } from '@/lib/hooks/useWorks';
import { getCreatorRevenue } from '@/lib/web3/services/contract.service';
import { useAccount } from 'wagmi';

export function ProfileView({ user }: { user: UserProfile }) {
  const { address } = useAccount();
  const { works } = useWorks(address);
  const [balance, setBalance] = useState('0');
  
  useEffect(() => {
    if (address) {
      loadBalance();
    }
  }, [address]);
  
  const loadBalance = async () => {
    if (!address) return;
    const revenue = await getCreatorRevenue(address);
    setBalance(formatEther(revenue));
  };
  
  // ... 渲染
}
```

---

## 🧪 测试计划

### 测试 1: 作品上传
1. 填写作品信息
2. 选择图片
3. 点击上传
4. 等待 IPFS 上传
5. 等待合约交易
6. 检查广场是否显示新作品

### 测试 2: 授权申请
1. 收藏一个作品
2. 点击 Remix
3. 点击 Pay & Mint License
4. 批准 MetaMask 交易
5. 等待确认
6. 检查按钮变为 "Upload Work"

### 测试 3: 个人资料
1. 进入个人资料页面
2. 检查是否显示用户作品
3. 检查余额是否正确
4. 测试 Withdraw 功能

---

## 📅 时间估算

| 功能 | 优先级 | 预计时间 | 状态 |
|------|--------|----------|------|
| 作品上传 | P0 | 2-3h | ❌ 待开始 |
| 授权支付 | P0 | 1-2h | ❌ 待开始 |
| 个人资料 | P1 | 1h | ❌ 待开始 |
| Tip 功能 | P1 | 1h | ❌ 待开始 |
| 创作谱系树 | P2 | 2-3h | ❌ 待开始 |

**总计**: 7-10 小时

---

## 🎯 今天的目标

建议按以下顺序完成：

1. ✅ 收藏功能集成（已完成）
2. ⏳ 作品上传功能（2-3小时）
3. ⏳ 授权支付流程（1-2小时）

完成这三个后，核心功能就基本完整了！

---

**准备好继续开发了吗？让我们从作品上传功能开始！** 🚀
